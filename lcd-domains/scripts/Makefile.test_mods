#
# test modules/examples build
#
# This is included in the top-level Makefile, and some
# variables are defined there.
# 

LCD_TEST_MODULES_DIR=$(PWD)/test_mods
export LCD_TEST_MODULES_DIR

LCD_TEST_MODULES_BUILD_DIR=$(LCD_BUILD_DIR)/test_mods
export LCD_TEST_MODULES_BUILD_DIR

# Collect all of the example directories and kbuilds
TEST_MODULES_DIRS=$(shell cd $(LCD_TEST_MODULES_DIR) && \
	find . -mindepth 1 -type d)
TEST_MODULES_KBUILDS=$(shell cd $(LCD_TEST_MODULES_DIR) && \
	find . -name "Kbuild")

TEST_MODULES_BUILD_DIRS=$(foreach dir,$(TEST_MODULES_DIRS), \
	$(LCD_TEST_MODULES_BUILD_DIR)/$(dir))
TEST_MODULES_BUILD_KBUILDS=$(foreach kb,$(TEST_MODULES_KBUILDS), \
	$(LCD_TEST_MODULES_BUILD_DIR)/$(kb))

KLIBLCD_SYMBOLS=$(MICROKERNEL_BUILD_DIR)/Module.symvers

LIBLCD_PATH_CMD=$(shell scripts/relpath.py $(LIBLCD_BUILD_DIR)/liblcd.a $(shell dirname $(shell readlink -f $@)))

# ------------------------------------------------------------
# CFLAGS for each build configuration

export NONISOLATED_CFLAGS=$(MICROKERNEL_CFLAGS)
export ISOLATED_CFLAGS=$(LIBLCD_CFLAGS)
export DEKER_CFLAGS=$(LIBDEKER_CFLAGS)

# ------------------------------------------------------------
# LIBDEKER

ifneq ($(DEKER),)

LIBDEKER_PATH_CMD=$(shell scripts/relpath.py $(LIBDEKER_BUILD_DIR)/libdeker.a $(shell dirname $(shell readlink -f $@)))

MAYBE_LIBDEKER=$(LIBDEKER_BUILD_PATH)/libdeker/libdeker.a

endif

# ------------------------------------------------------------
# Targets

test_mods: $(LCD_TEST_MODULES_BUILD_DIR)/Kbuild \
	$(LCD_TEST_MODULES_BUILD_DIR)/Kbuild.config \
	$(TEST_MODULES_BUILD_KBUILDS) | \
	$(LIBLCD_BUILD_DIR)/liblcd.a $(TEST_MODULES_BUILD_DIRS) \
	$(MAYBE_LIBDEKER)  
	$(MAKE) -C .. M=$(LCD_TEST_MODULES_BUILD_DIR) \
	KBUILD_EXTRA_SYMBOLS=$(KLIBLCD_SYMBOLS) $(MAKEFLAGS)

$(LCD_TEST_MODULES_BUILD_DIR)/%/Kbuild: $(LCD_TEST_MODULES_DIR)/%/Kbuild | \
	$(TEST_MODULES_BUILD_DIRS)
	@echo "  KBUILD     $^"
	@printf "#\n# BEGIN: Auto-generated part.\n#\n" > $@ && \
	printf "\n" >> $@ && \
	printf "LIBDEKER=$(LIBDEKER_PATH_CMD)\n" >> $@ && \
	printf "LIBLCD=$(LIBLCD_PATH_CMD)\n" >> $@ && \
	printf "src=$(shell dirname `readlink -f $<`)\n" >> $@ && \
	printf "\n" >> $@ && \
	printf "#\n# END: Auto-generated part.\n#\n" >> $@ && \
	printf "\n" >> $@ && \
	cat $^ >> $@

$(LCD_TEST_MODULES_BUILD_DIR)/Kbuild: scripts/Kbuild.test_mods \
	$(LCD_TEST_MODULES_BUILD_DIR)/Kbuild.config | \
	$(TEST_MODULES_BUILD_DIRS)
	cp scripts/Kbuild.test_mods $(LCD_TEST_MODULES_BUILD_DIR)/Kbuild

$(LCD_TEST_MODULES_BUILD_DIR)/Kbuild.config: test_mods/config | \
	$(TEST_MODULES_BUILD_DIRS)
	cat test_mods/config | awk -f scripts/conf.awk > $@

$(TEST_MODULES_BUILD_DIRS):
	@echo "  MKDIR      $@"
	@mkdir -p $@

clean-test_mods:
	if test -e $(LCD_TEST_MODULES_BUILD_DIR)/Kbuild; then \
		$(MAKE) -C .. M=$(LCD_TEST_MODULES_BUILD_DIR) clean; \
	fi

clean += clean-test_mods

.PHONY += \
	test_mods \
	clean-test_mods
